<html xmlns:th="http://www.thymeleaf.org">
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오늘뭐하지 ? | 할일 지도</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" th:href="@{/css/nav.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/nav-footer.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/map.css}" />
</head>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d6c4c6c3f782007214fd49e572b5bde9&libraries=services"></script>

<style>

</style>
<body>
<th:block th:replace="fragments/navbar :: navbarFragment"></th:block>
<th:block th:replace="fragments/mapNav :: mapNavFragment"></th:block>

<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="embed-responsive embed-responsive-16by9" style="height: calc(100dvh - 4rem - 4rem);">
                <div id="map" class="embed-responsive-item"></div>
            </div>
        </div>
    </div>
</div>
<th:block th:replace="fragments/footer :: footerFragment"></th:block>
<script>
    function changeColor() {
     var link1 = document.getElementById('active-link2');
     var link2 = document.getElementById('nav-slot2');
     var link3 = document.getElementById('nav-item2');
      link1.classList.add('active');
      link2.classList.add('active');
      link3.classList.add('active');
}
window.onload = changeColor;
</script>
<script>
    var mapContainer = document.getElementById('map'); // 지도의 중심좌표
    var mapOption = {
      center: new kakao.maps.LatLng(37.564113693988524, 126.98980189926252), // 지도의 중심좌표
      level: 11 // 지도의 확대 레벨
    };

    var geocoder = new kakao.maps.services.Geocoder();

    var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

    var overlays = []; // overlay 배열을 선언합니다.

    var zoomControl = new kakao.maps.ZoomControl();
    map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

    fetch('/map/marker/1')
      .then(response => response.json())
      .then(data => {
        var positions = data.map(marker => ({
          latlng: new kakao.maps.LatLng(marker.latitude, marker.longitude),
          name: marker.name,
          tel: marker.tel
        }));

        for (var i = 0; i < positions.length; i++) {
          (function(i) { // 클로저를 사용하여 i 값을 유지합니다.
            var name = positions[i].name;
            var tel = positions[i].tel;

            var marker = new kakao.maps.Marker({
              map: map,
              position: positions[i].latlng,
              name: positions[i].name,
              tel : positions[i].tel
            });
            var overlay = null; // 초기에 overlay를 null로 설정합니다.

            // 마커를 클릭했을 때 커스텀 오버레이를 표시합니다
            kakao.maps.event.addListener(marker, 'click', (function(marker, overlay) {
              return function() {
                // 클릭된 마커의 overlay만 표시하도록 설정합니다.
                for (var j = 0; j < overlays.length; j++) {
                  overlays[j]?.setMap(null);
                }

                searchDetailAddrFromCoords(positions[i].latlng, function(address) {
                  var content =
                    '<div class="wrap">' +
                    '    <div class="info">' +
                    '        <div class="title">' +
                    '            ' + name + // name 변수 사용
                    '            <div class="close" onclick="closeOverlay(' + i + ')" title="닫기"></div>' +
                    '        </div>' +
                    '        <div class="body">' +
                    '            <div class="desc">' +
                    '                <div class="jibun ellipsis">'+ tel +'</div>' +
                    '                <div class="ellipsis address">' + address + '</div>' +
                    '            </div>' +
                    '        </div>' +
                    '    </div>' +
                    '</div>';

                  overlay = new kakao.maps.CustomOverlay({
                    content: content,
                    map: map,
                    position: marker.getPosition()
                  });
                  overlays[i] = overlay; // 해당 인덱스에 overlay를 할당합니다.
                });
              };
            })(marker, overlay));
          })(i); // 클로저에 i 값을 전달합니다.
        }
      })
      .catch(error => {
        console.error(error);
      });

    // 지도 클릭 이벤트 처리
    kakao.maps.event.addListener(map, 'click', function() {
      for (var j = 0; j < overlays.length; j++) {
        if (overlays[j]) {
          overlays[j].setMap(null);
        }
      }
    });

    // 커스텀 오버레이를 닫기 위해 호출되는 함수입니다
    function closeOverlay(index) {
      if (overlays[index]) {
        overlays[index].setMap(null);
      }
    }

    function searchDetailAddrFromCoords(coords, callback) {
      // 좌표로 법정동 상세 주소 정보를 요청합니다
      var geocoder = new kakao.maps.services.Geocoder();
      geocoder.coord2Address(coords.getLng(), coords.getLat(), function(result, status) {
        if (status === kakao.maps.services.Status.OK) {
          var address = result[0].address.address_name;
          callback(address); // address 값을 callback 함수로 전달합니다.
        }
      });
    }


</script>
</body>
</html>